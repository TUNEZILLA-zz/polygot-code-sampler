<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ Code Opera - Conductor Panel</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(45deg, #0f172a, #1e293b);
            color: #e2e8f0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .conductor-panel {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(75, 108, 255, 0.1);
            border: 2px solid #4b6cff;
            border-radius: 15px;
            padding: 30px;
        }
        
        .title {
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #4b6cff, #2dd4bf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .control-group {
            background: rgba(45, 212, 191, 0.1);
            border: 1px solid #2dd4bf;
            border-radius: 10px;
            padding: 20px;
        }
        
        .control-group h3 {
            margin-top: 0;
            color: #2dd4bf;
        }
        
        label {
            display: block;
            margin: 10px 0;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #4b6cff;
            border-radius: 5px;
            background: #0f172a;
            color: #e2e8f0;
        }
        
        button {
            background: linear-gradient(45deg, #4b6cff, #2dd4bf);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(75, 108, 255, 0.4);
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 10px;
        }
        
        .voice-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .voice-control {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid #8b5cf6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .voice-name {
            font-weight: bold;
            color: #8b5cf6;
            margin-bottom: 10px;
        }
        
        .slider {
            width: 100%;
            margin: 5px 0;
        }
        
        .value-display {
            font-size: 0.9em;
            color: #94a3b8;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="conductor-panel">
        <h1 class="title">üé≠ Code Opera - Conductor Panel</h1>
        
        <div class="status" id="status">
            üé≠ Connected to Code Opera
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>üéµ Global Controls</h3>
                <label>
                    BPM: <span id="bpm-value">96</span>
                    <input id="bpm" type="range" min="60" max="160" value="96" class="slider"/>
                </label>
                <label>
                    Key:
                    <select id="key">
                        <option value="C">C Major</option>
                        <option value="G">G Major</option>
                        <option value="F">F Major</option>
                        <option value="D">D Major</option>
                        <option value="A">A Major</option>
                        <option value="E">E Major</option>
                    </select>
                </label>
                <label>
                    Seed:
                    <input id="seed" type="text" placeholder="auto-generate"/>
                </label>
                <button id="apply-global">Apply Global Settings</button>
            </div>
            
            <div class="control-group">
                <h3>üé≠ Performance Controls</h3>
                <button id="advance-act">Advance to Next Act</button>
                <button id="reset-performance">Reset to Act I</button>
                <button id="update-metrics">Update Metrics</button>
            </div>
        </div>
        
        <div class="voice-controls" id="voice-controls">
            <!-- Voice controls will be populated by JavaScript -->
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>üìä Performance Metrics</h3>
                <label>
                    P95 Latency: <span id="p95-value">0</span>ms
                    <input id="p95" type="range" min="0" max="500" value="0" class="slider"/>
                </label>
                <label>
                    Error Rate: <span id="error-value">0</span>%
                    <input id="error" type="range" min="0" max="100" value="0" step="1" class="slider"/>
                </label>
                <label>
                    QPS: <span id="qps-value">0</span>
                    <input id="qps" type="range" min="0" max="200" value="0" class="slider"/>
                </label>
                <button id="apply-metrics">Apply Metrics</button>
            </div>
        </div>
    </div>
    
    <script>
        // API functions
        async function getState() {
            try {
                const response = await fetch('/opera/state');
                return await response.json();
            } catch (error) {
                console.error('Failed to get state:', error);
                return null;
            }
        }
        
        async function setState(patch) {
            try {
                const response = await fetch('/opera/state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patch)
                });
                return await response.json();
            } catch (error) {
                console.error('Failed to set state:', error);
                return null;
            }
        }
        
        async function advanceAct() {
            try {
                const response = await fetch('/opera/advance', { method: 'POST' });
                return await response.json();
            } catch (error) {
                console.error('Failed to advance act:', error);
                return null;
            }
        }
        
        async function resetPerformance() {
            try {
                const response = await fetch('/opera/reset', { method: 'POST' });
                return await response.json();
            } catch (error) {
                console.error('Failed to reset performance:', error);
                return null;
            }
        }
        
        async function updateMetrics() {
            try {
                const response = await fetch('/opera/metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p95_latency: parseFloat(document.getElementById('p95').value),
                        error_rate: parseFloat(document.getElementById('error').value) / 100,
                        qps: parseFloat(document.getElementById('qps').value)
                    })
                });
                return await response.json();
            } catch (error) {
                console.error('Failed to update metrics:', error);
                return null;
            }
        }
        
        // Update UI with current state
        async function updateUI() {
            const state = await getState();
            if (!state) {
                document.getElementById('status').textContent = '‚ùå Failed to connect to Code Opera';
                return;
            }
            
            // Update global controls
            document.getElementById('bpm').value = state.bpm;
            document.getElementById('bpm-value').textContent = state.bpm;
            document.getElementById('key').value = state.key;
            document.getElementById('seed').value = state.seed || '';
            
            // Update metrics
            document.getElementById('p95').value = state.p95_latency || 0;
            document.getElementById('p95-value').textContent = state.p95_latency || 0;
            document.getElementById('error').value = (state.error_rate || 0) * 100;
            document.getElementById('error-value').textContent = Math.round((state.error_rate || 0) * 100);
            document.getElementById('qps').value = state.qps || 0;
            document.getElementById('qps-value').textContent = state.qps || 0;
            
            // Update voice controls
            updateVoiceControls(state.voices);
            
            document.getElementById('status').textContent = `üé≠ Connected - Act ${state.act || 1}`;
        }
        
        // Update voice controls
        function updateVoiceControls(voices) {
            const container = document.getElementById('voice-controls');
            container.innerHTML = '';
            
            for (const [name, voice] of Object.entries(voices)) {
                const voiceControl = document.createElement('div');
                voiceControl.className = 'voice-control';
                voiceControl.innerHTML = `
                    <div class="voice-name">${name.toUpperCase()}</div>
                    <label>
                        Gain: <span class="value-display">${Math.round(voice.gain * 100)}%</span>
                        <input type="range" min="0" max="1" step="0.1" value="${voice.gain}" 
                               class="slider" data-voice="${name}" data-param="gain"/>
                    </label>
                    <label>
                        <input type="checkbox" ${voice.muted ? 'checked' : ''} 
                               data-voice="${name}" data-param="muted"/> Muted
                    </label>
                    <label>
                        <input type="checkbox" ${voice.solo ? 'checked' : ''} 
                               data-voice="${name}" data-param="solo"/> Solo
                    </label>
                `;
                container.appendChild(voiceControl);
            }
        }
        
        // Event listeners
        document.getElementById('apply-global').onclick = async () => {
            const patch = {
                bpm: parseInt(document.getElementById('bpm').value),
                key: document.getElementById('key').value,
                seed: document.getElementById('seed').value || undefined
            };
            await setState(patch);
            await updateUI();
        };
        
        document.getElementById('advance-act').onclick = async () => {
            await advanceAct();
            await updateUI();
        };
        
        document.getElementById('reset-performance').onclick = async () => {
            await resetPerformance();
            await updateUI();
        };
        
        document.getElementById('apply-metrics').onclick = async () => {
            await updateMetrics();
            await updateUI();
        };
        
        // Voice control event listeners
        document.addEventListener('change', async (e) => {
            if (e.target.dataset.voice && e.target.dataset.param) {
                const voice = e.target.dataset.voice;
                const param = e.target.dataset.param;
                const value = e.target.type === 'checkbox' ? e.target.checked : parseFloat(e.target.value);
                
                const patch = {
                    voices: {
                        [voice]: {
                            [param]: value
                        }
                    }
                };
                await setState(patch);
                await updateUI();
            }
        });
        
        // Update value displays
        document.addEventListener('input', (e) => {
            if (e.target.type === 'range') {
                const valueDisplay = e.target.parentElement.querySelector('.value-display');
                if (valueDisplay) {
                    if (e.target.id === 'bpm') {
                        valueDisplay.textContent = e.target.value;
                    } else if (e.target.id === 'p95') {
                        valueDisplay.textContent = e.target.value;
                    } else if (e.target.id === 'error') {
                        valueDisplay.textContent = e.target.value;
                    } else if (e.target.id === 'qps') {
                        valueDisplay.textContent = e.target.value;
                    } else if (e.target.dataset.param === 'gain') {
                        valueDisplay.textContent = Math.round(e.target.value * 100) + '%';
                    }
                }
            }
        });
        
        // Initialize
        (async () => {
            await updateUI();
            // Auto-refresh every 5 seconds
            setInterval(updateUI, 5000);
        })();
    </script>
</body>
</html>
