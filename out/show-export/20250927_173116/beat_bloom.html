<!doctype html><meta charset="utf-8"><title>Beat Bloom</title>
<style>html,body{margin:0;background:#000;color:#9ef;font:12px ui-monospace}
#s{position:fixed;left:10px;bottom:10px;opacity:.8}</style>
<div id="s">Beat Bloom • mic → /rig/bloom</div>
<script>
const RED=new URLSearchParams(location.search).get('reduced')==='1';
let ctx,an,buf,last=0,acc=0,th=RED?0.28:0.22,cool=RED?220:160; // ms cooldown
async function boot(){
  ctx=new (window.AudioContext||webkitAudioContext)();
  an=ctx.createAnalyser(); an.fftSize=512; buf=new Uint8Array(an.frequencyBinCount);
  const s=await navigator.mediaDevices.getUserMedia({audio:true});
  ctx.createMediaStreamSource(s).connect(an);
  loop();
}
async function bloom(ms=RED?600:900){
  try{ await fetch('http://localhost:8787/rig/bloom',{method:'POST',
    headers:{'content-type':'application/json'},body:JSON.stringify({latch_ms:ms})}); }catch(_){}
}
function loop(t=0){requestAnimationFrame(loop); if(!an)return; an.getByteTimeDomainData(buf);
  // simple onset: normalized energy delta + short cooldown
  let e=0; for(let i=0;i<buf.length;i++){let v=(buf[i]-128)/128; e+=v*v;} e/=buf.length;
  acc = acc*0.85 + e*0.15; // smoothed
  const now=performance.now();
  if(acc>th && now-last>cool){ last=now; bloom(); }
}
boot();
</script>
