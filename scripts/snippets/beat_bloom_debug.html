<!doctype html><meta charset="utf-8"><title>Beat Bloom Debug</title>
<style>html,body{margin:0;background:#000;color:#9ef;font:12px ui-monospace}
#status{position:fixed;left:10px;top:10px;opacity:.8}
#level{position:fixed;left:10px;top:40px;width:300px;height:20px;background:#333;border:1px solid #666;}
#bar{height:100%;background:linear-gradient(90deg, #0f0, #ff0, #f00);width:0%;transition:width 0.1s ease-out;}
#bloom{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:100vw;height:100vh;background:radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.5) 40%, transparent 80%);pointer-events:none;opacity:0;transition:opacity 0.2s ease-out;}
#debug{position:fixed;left:10px;bottom:10px;font-size:10px;opacity:.6;max-height:200px;overflow-y:auto;}
</style>
<div id="status">ðŸŽµ Beat Bloom Debug - Starting...</div>
<div id="level"><div id="bar"></div></div>
<div id="bloom"></div>
<div id="debug"></div>
<script>
const RED=new URLSearchParams(location.search).get('reduced')==='1';
let ctx,an,buf,last=0,acc=0,th=0.1,cool=500; // Much lower threshold
const bloomEl = document.getElementById('bloom');
const barEl = document.getElementById('bar');
const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');

function log(msg) {
  debugEl.innerHTML = new Date().toLocaleTimeString() + ': ' + msg + '<br>' + debugEl.innerHTML;
  console.log(msg);
}

async function boot(){
  try {
    log('ðŸŽµ Requesting mic permission...');
    ctx=new (window.AudioContext||webkitAudioContext)();
    an=ctx.createAnalyser(); 
    an.fftSize=512; 
    buf=new Uint8Array(an.frequencyBinCount);
    
    log('ðŸŽµ Getting user media...');
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    log('âœ… Mic permission granted!');
    
    ctx.createMediaStreamSource(s).connect(an);
    statusEl.textContent = 'ðŸŽµ Beat Bloom Debug - Mic Ready âœ…';
    log('ðŸŽµ Audio analysis started');
    loop();
  } catch(e) {
    log('âŒ Error: ' + e.message);
    statusEl.textContent = 'ðŸŽµ Beat Bloom Debug - Error: ' + e.message;
  }
}

function bloom(ms=800){
  log('ðŸŽµ BEAT DETECTED! Bloom triggered');
  bloomEl.style.opacity = '1';
  setTimeout(() => {
    bloomEl.style.opacity = '0';
  }, ms);
}

function loop(t=0){requestAnimationFrame(loop); 
  if(!an) return; 
  
  an.getByteTimeDomainData(buf);
  
  // Calculate energy
  let e=0; 
  for(let i=0;i<buf.length;i++){
    let v=(buf[i]-128)/128; 
    e+=v*v;
  } 
  e/=buf.length;
  
  // Smooth the energy
  acc = acc*0.85 + e*0.15;
  
  // Update level bar
  const levelPercent = Math.min(acc * 200, 100); // Scale up for visibility
  barEl.style.width = levelPercent + '%';
  
  // Show current values every 2 seconds
  if(Math.floor(t/2000) !== Math.floor((t-16)/2000)) {
    log(`Level: ${acc.toFixed(4)} (${levelPercent.toFixed(1)}%) Threshold: ${th.toFixed(4)}`);
  }
  
  const now=performance.now();
  if(acc>th && now-last>cool){ 
    last=now; 
    bloom(); 
  }
}

log('ðŸŽµ Starting beat bloom debug...');
boot();
</script>


