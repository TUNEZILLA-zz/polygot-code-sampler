name: Conventional Commits Check
on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  conventional-commits:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check commit messages
      uses: amannn/action-conventional-commits@v2
      with:
        # Allow these types
        types: |
          feat
          fix
          docs
          style
          refactor
          test
          chore
          ci
          build
          perf
          revert
        # Require scope for certain types
        scopes: |
          pcs
          server
          docs
          ci
          bench
          site
        # Allow breaking changes
        allowBreakingChanges: true
        # Require body for certain types
        requireBody: true
        # Require footer for certain types
        requireFooter: false

    - name: Generate changelog preview
      run: |
        echo "📝 Changelog Preview:"
        echo "===================="

        # Get commits since last tag
        last_tag=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        if [[ -n "$last_tag" ]]; then
          echo "Changes since $last_tag:"
          git log --pretty=format:"- %s (%h)" --since="$last_tag" | head -10
        else
          echo "All commits:"
          git log --pretty=format:"- %s (%h)" -10
        fi
